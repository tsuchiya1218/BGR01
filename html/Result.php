<?php
try {
    $dsn = 'sqlsrv:server=10.42.129.3;database=20grb1';
    $user = '20grb1';
    $password = '20grb1';
    //PDO„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆ‰ΩúÊàê
    $dbh = new PDO($dsn, $user, $password);
    $dbh->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
} catch (PDOException $e) {
    print "Êé•Á∂ö„Ç®„É©„Éº!: " . $e->getMessage() . "<br/>";
    die();
}
?>

<!DOCTYPE html>
<html lang="ja">

<head>
    <title>Ê§úÁ¥¢ÁµêÊûú</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../css/result.css" rel="stylesheet" type="text/css">
    <link href="../css/common.css" rel="stylesheet" type="text/css">
</head>

<body>
    <header>
        <div id="top">
            <h1 id="title">BOOK ON</h1>
            <p id="subtitle">It's a book but it's not a book!</p>
            <div id="right">
                <input type="button" value="„Ç´„Éº„Éà„ÇíË¶ã„Çã">
                <input type="button" value="„É≠„Ç∞„Ç§„É≥">
            </div>
        </div>
        <hr>
        <div align="center">
            <select name="searchCondition">
                <option value="b_title">Êõ∏Á±ç</option>
                <option value="author">‰ΩúËÄÖ</option>
            </select>
            <input type="text" name="searchWord">
            <input type="submit" value="üîç">
        </div>
        <hr>
    </header>
    <main>
        <?php
        $searchCondition = htmlspecialchars($_GET['searchCondition']);
        $searchWord = htmlspecialchars($_GET['searchWord']);
        $rank = htmlspecialchars($_GET['rank']); //top.php„Åßname„ÅåÁ¢∫ÂÆöÊ¨°Á¨¨Â§âÊõ¥
        $rank = htmlspecialchars($_GET['new']); //top.php„Åßname„ÅåÁ¢∫ÂÆöÊ¨°Á¨¨Â§âÊõ¥
        if (isset($searchWord)) {
            if ($searchCondition == "b_title") {
                $sql = 'SELECT b_code,b_name,b_thum,b_author,b_release,b_purchaseprice,b_rentalprice
                                   FROM book WHERE b_title like %?%';
                try {
                    // SQL Êñá„ÇíÊ∫ñÂÇô
                    $stmt = $pdo->prepare($sql);
                    // SQL Êñá„ÇíÂÆüË°å
                    $stmt->execute(array($b_title));
                    // ÂÆüË°åÁµêÊûú„Çí„Åæ„Å®„ÇÅ„Å¶Âèñ„ÇäÂá∫„Åó(„Ç´„É©„É†Âêç„ÅßÊ∑ªÂ≠ó„Çí‰ªò„Åë„ÅüÈÖçÂàó)
                    $array = $stmt->fetchAll(PDO::FETCH_ASSOC);
                    $stmt = null;
                    $pdo = null;
                } catch (PDOException $e) {
                    print "SQL ÂÆüË°å„Ç®„É©„Éº!: " . $e->getMessage();
                    exit();
                }
                echo "<h3>'" . $searchCondition . "," . $searchWord . "'„ÅßÊ§úÁ¥¢</h3>";
            } elseif ($searchCondition == "author") {
                $sql = 'SELECT b_code,b_name,b_thum,b_author,b_release,b_purchaseprice,b_rentalprice
                                   FROM book WHERE b_author like %?%';
                try {
                    // SQL Êñá„ÇíÊ∫ñÂÇô
                    $stmt = $pdo->prepare($sql);
                    // SQL Êñá„ÇíÂÆüË°å
                    $stmt->execute(array($b_author));
                    // ÂÆüË°åÁµêÊûú„Çí„Åæ„Å®„ÇÅ„Å¶Âèñ„ÇäÂá∫„Åó(„Ç´„É©„É†Âêç„ÅßÊ∑ªÂ≠ó„Çí‰ªò„Åë„ÅüÈÖçÂàó)
                    $array = $stmt->fetchAll(PDO::FETCH_ASSOC);
                    $stmt = null;
                    $pdo = null;
                } catch (PDOException $e) {
                    print "SQL ÂÆüË°å„Ç®„É©„Éº!: " . $e->getMessage();
                    exit();
                }
                echo "<h3>'" . $searchCondition . "," . $searchWord . "'„ÅßÊ§úÁ¥¢</h3>";
            }
        } elseif (isset($rank)) {
            $sql = 'SELECT b_code,b_name,b_thum,b_author,b_release,b_purchaseprice,b_rentalprice
                               FROM book ORDER BY b_boughtQty DESC';
            try {
                // SQL Êñá„ÇíÊ∫ñÂÇô
                $stmt = $pdo->prepare($sql);
                // SQL Êñá„ÇíÂÆüË°å
                $stmt->execute();
                // ÂÆüË°åÁµêÊûú„Çí„Åæ„Å®„ÇÅ„Å¶Âèñ„ÇäÂá∫„Åó(„Ç´„É©„É†Âêç„ÅßÊ∑ªÂ≠ó„Çí‰ªò„Åë„ÅüÈÖçÂàó)
                $array = $stmt->fetchAll(PDO::FETCH_ASSOC);
                $stmt = null;
                $pdo = null;
            } catch (PDOException $e) {
                print "SQL ÂÆüË°å„Ç®„É©„Éº!: " . $e->getMessage();
                exit();
            }
            echo "<h3>" . $rank . "<h3>";
        } elseif (isset($new)) {
            $sql = 'SELECT b_code,b_name,b_thum,b_author,b_release,b_purchaseprice,b_rentalprice
                               FROM book ORDER BY b_release DESC';
            try {
                // SQL Êñá„ÇíÊ∫ñÂÇô
                $stmt = $pdo->prepare($sql);
                // SQL Êñá„ÇíÂÆüË°å
                $stmt->execute();
                // ÂÆüË°åÁµêÊûú„Çí„Åæ„Å®„ÇÅ„Å¶Âèñ„ÇäÂá∫„Åó(„Ç´„É©„É†Âêç„ÅßÊ∑ªÂ≠ó„Çí‰ªò„Åë„ÅüÈÖçÂàó)
                $array = $stmt->fetchAll(PDO::FETCH_ASSOC);
                $stmt = null;
                $pdo = null;
            } catch (PDOException $e) {
                print "SQL ÂÆüË°å„Ç®„É©„Éº!: " . $e->getMessage();
                exit();
            }
            echo "<h3>" . $new . "<h3>";
        }
        ?>
        <?php
        foreach ($array as $value) {
        ?>
            <div class="result">
                <div class="list1">
                    <div class="img">
                        <img class="thum" src="<?php $value['b_thum'] ?>" alt="<?php $value['b_name'] ?>">
                    </div>
                </div>
                <div class="list2">
                    <div class=" b_name">
                        <a href="Detail.php?b_code=<?php $value['b_code'] ?>" class="title"><?php $value['b_name'] ?></a>
                    </div>
                    <div class="other">
                        <div class="author ">
                            <a><?php $value['b_name'] ?></a>
                        </div>
                        <div class="pub ">
                            <a><?php $value['b_publisher'] ?></a>
                        </div>
                        <div class="date ">
                            <a><?php $value['b_release'] ?></a>
                        </div>
                    </div>
                    <div class="bi">
                        <form method="GET" action="./addCart.php">
                            <div class="tab">
                                <!--b_code=name-->
                                <a href="Cart.php?b_code=<?php $value['b_code'] ?>">Ë≥ºÂÖ•</a>
                                <input type="hidden" name="b" value="buy">
                                <p class="tax">Á®éËæº</p>
                                <p class="price">&yen;<?php $value['b_purchaseprice'] ?></p>
                                <p class="cart">„Ç´„Éº„Éà„Å´ÂÖ•„Çå„Çã</p>
                                <!--phpÂá∫Êù•„Åü„Çâ‰∏ä„ÅÆ„É™„É≥„ÇØÂ§âÊõ¥-->
                                <!--Âú®Â∫´„Åå„ÅÇ„ÇãÂ†¥ÂêàË≥ºÂÖ•Ë°®Á§∫„ÄÅ„Å™„ÅÑÂ†¥Âêà‰∫àÁ¥ÑË°®Á§∫-->
                            </div>
                        </form>
                        <form method="GET" action="./addCart.php">
                            <div class="tab">
                                <!--b_code=name-->
                                <a href="Cart.php?b_code=<?php $value['b_code'] ?>">„É¨„É≥„Çø„É´</a>
                                <input type="hidden" name="b" value="rent">
                                <p class="tax">Á®éËæº</p>
                                <p class="price">&yen;<?php $value['b_rentalprice'] ?></p>
                                <p class="cart">„Ç´„Éº„Éà„Å´ÂÖ•„Çå„Çã</p>
                                <!--phpÂá∫Êù•„Åü„Çâ‰∏ä„ÅÆ„É™„É≥„ÇØÂ§âÊõ¥-->
                                <!--„É¨„É≥„Çø„É´Âá∫Êù•„Å™„ÅÑÂ†¥Âêà„É™„É≥„ÇØ„ÇíÊ∂à„Åô-->
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        <?php
        }
        ?>
    </main>
    <footer>

    </footer>
</body>

</html>